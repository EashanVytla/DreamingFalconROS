Bootstrap: docker
From: ubuntu:22.04

%post
    # Update package list and install necessary dependencies
    apt-get update && apt-get install -y \
        lsb-release \
        gnupg \
        curl \
        wget \
        git \
        python3-pip \
        build-essential \
        cmake \
        ninja-build \
        protobuf-compiler \
        libeigen3-dev \
        libgtest-dev \
        python3-colcon-common-extensions \
        python3-rosdep \
        python3-vcstool \
        ros-humble-desktop \
        ros-humble-ros-base \
        ros-humble-gazebo-ros-pkgs \
        ros-humble-xacro \
        ros-humble-rqt \
        ros-humble-rviz2 \
        libopencv-dev \
        libyaml-cpp-dev \
        && rm -rf /var/lib/apt/lists/*

    # Setup ROS 2 environment
    echo "source /opt/ros/humble/setup.bash" >> ~/.bashrc

    # Install PX4 dependencies
    useradd --create-home --shell /bin/bash px4user
    echo "px4user ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers
    su - px4user -c "
        git clone --recursive https://github.com/PX4/PX4-Autopilot.git ~/PX4-Autopilot && \
        cd ~/PX4-Autopilot && \
        bash Tools/setup/ubuntu.sh
    "

%environment
    source /opt/ros/humble/setup.bash
    export PATH="/home/px4user/PX4-Autopilot:$PATH"
    export PX4_SIM_MODEL=iris

%runscript
    exec "$@"
